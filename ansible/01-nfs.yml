---

- hosts: nfs
  gather_facts: yes
  tasks:
    - name: Install nfs server packages
      become: true
      apt:
        name: nfs-kernel-server

    - name: Create mountable dir
      become: true
      file: path=/srv/nfs state=directory mode=777 owner=root group=root

    - name: Start nfs server
      become: true
      shell: service nfs-kernel-server start

    - name: Clean exports files (to allow multiple runs)
      become: true
      shell: echo "#==== File generated by ansible from hosts data" > /etc/exports

    - name: Create one line for each exports (comment with the name of the host jumpline /srv/nfs and ip then jumpline)
      become: true
      shell: echo "#{{ item }}\n/srv/nfs\t{{ hostvars[item].ansible_host }}\n" >> /etc/exports
      loop: "{{ [groups['workers'],groups['master']] | flatten(1) }}" #This takes two lists and unifies them as only one

    - name: run nfs-kernel-server a service
      become: true
      shell: service nfs-kernel-server start